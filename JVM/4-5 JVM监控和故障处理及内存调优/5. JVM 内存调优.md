对JVM内存的系统级的调优主要的⽬的是**减少GC的频率**和**Full GC的次数**。过多的GC和
Full GC是会占⽤很多的系统资源（主要是CPU），影响系统的吞吐量。

### 5.2.1 大内存硬件上的程序部署策略

- **问题**：在线文档类型网站更换了硬件系统后，网站经常不定期出现长时间失去响应。
- **原因**：过大的堆内存回收导致的长时间停顿，虚拟机默认使用吞吐量优先收集器，在收集12GB堆时导致长达14秒的停顿。
- **解决方法**：调整为建立5个32位JDK的逻辑集群，每个进程固定1.5GB堆内存，改用CMS收集器进行垃圾回收 。

### 5.2.2 集群间同步导致的内存溢出

- **问题**：MIS系统在使用JBossCache构建的全局缓存后，不定期出现内存溢出问题。
- **原因**：部分数据共享实现方式及JBoss Cache本身的缺陷，导致内存溢出。
- **解决方法**：修改集群缓存同步机制，避免频繁的写操作，降低网络同步开销 。

### 5.2.3 堆外内存导致的溢出错误

- **问题**：电子考试系统使用逆向AJAX技术后，服务端不定时抛出内存溢出异常。
- **原因**：逆向AJAX技术（CometD）导致堆外内存溢出。
- **解决方法**：适当调整系统的内存配置，减少不必要的外部请求，优化内存使用 。

### 5.2.4 外部命令导致系统缓慢

- **问题**：数字校园应用系统在大并发压力测试时发现请求响应时间慢，处理器使用率高。
- **原因**：每个用户请求处理都需要执行外部Shell脚本，创建进程的开销非常大。
- **解决方法**：去掉Shell脚本执行语句，改用Java API获取信息 。

### 5.2.5 服务器虚拟机进程崩溃

- **问题**：MIS系统的虚拟机进程自动关闭，留下hs_err_pid###.log文件后进程消失。
- **原因**：Web服务异步调用导致等待的线程和Socket连接越来越多，超过虚拟机承受能力。
- **解决方法**：修复OA门户的集成接口，改为生产者/消费者模式的消息队列实现 。

### 5.2.6 不恰当数据结构导致内存占用过大

- **问题**：后台RPC服务器在分析数据文件时Minor GC造成超过500毫秒的停顿。
- **原因**：使用HashMap<Long, Long>存储数据，空间效率低。
- **解决方法**：优化数据存储结构，提高空间效率 。

### 5.2.7 由Windows虚拟内存导致的长时间停顿

- **问题**：GUI桌面程序出现约一分钟的时间完全无日志输出，处于停顿状态。
- **原因**：程序最小化时工作内存被自动交换到磁盘的页面文件中。
- **解决方法**：使用`-Dsun.awt.keepWorkingSetOnMinimize=true`参数避免工作内存被交换 。

### 5.2.8 由安全点导致长时间停顿

- **问题**：HBase集群垃圾收集停顿经常达到3秒以上。
- **原因**：安全点等待，有线程响应特别慢导致自旋等待。
- **解决方法**：优化线程响应速度，减少到达安全点的时间。


#### 调优大纲

1. **调优前的程序运行状态分析**：了解和记录应用程序在未进行调优之前的内存使用状况，分析堆内存快照和GC日志等。
    
2. **识别内存问题**：通过JMC工具和日志分析，识别出应用程序存在的内存问题，如内存泄露、频繁的垃圾收集、长时间的停顿（GC时间超过1秒）等。
    
3. **确定调优目标**：基于识别出的问题和应用程序的实际需求，确定调优的目标，如减少内存使用量、减少垃圾收集的频率和停顿时间，如果等。
    
4. **选择和配置垃圾收集器**：根据应用的特点和调优目标选择合适的垃圾收集器，并对其进行配置。不同的垃圾收集器适用于不同的场景和需求。
    
5. **调整堆大小和结构**：根据应用的内存需求和垃圾收集器的特性，调整Java堆的大小和结构，如新生代和老年代的比例、堆的最大和最小大小等。
    
6. **优化代码**：通过代码级别的优化减少内存使用和提高效率，如优化数据结构、减少不必要的对象创建等。
    
7. **监控和调整**：在实际运行中监控应用的内存使用情况和垃圾收集行为，根据监控结果进一步调整配置和优化策略。

### CMS收集器概述

- **目标**: CMS(Concurrent Mark Sweep)收集器主要目标是==**获取最短回收停顿时间**==，特别适用于互联网或B/S系统服务端应用（关注响应速度）。
- **基础**: 基于*标记-清除算法*，过程更为复杂，分为初始标记、并发标记、重新标记、并发清除四个步骤。
- **特性**: 重点在于*减少垃圾收集时的停顿时间* ，实现*垃圾收集线程与用户线程的并发运行*。

### CMS收集器的工作过程

1. **初始标记(CMS initial mark)**: 快速标记GC Roots能直接关联到的对象，*需要停顿*。
2. **并发标记(CMS concurrent mark)**: 从GC Roots开始遍历整个对象图，耗时长但*无需停顿*。==**增量更新算法**==
3. **重新标记(CMS remark)**: 修正并发标记期间由于用户程序运作导致的变动，较初始标记*停顿时间稍长*。
4. **并发清除(CMS concurrent sweep)**: 清理掉死亡对象，无需停顿。

![[CMS 收集器.png]]

### CMS收集器的优点与缺点

- **优点**: *并发收集、低停顿* ，适合互联网服务或交互式应用。
- **缺点**:
    - **处理器资源敏感**：对CPU资源敏感，尤其在==单核或少核环境下对应用影响大==。
    - **浮动垃圾**：无法处理并发阶段产生的*浮动垃圾*，可能导致Concurrent Mode Failure。
	    - 在CMS的并发阶段中，因用户线程持续运行而产生的新垃圾，称为“浮动垃圾”，只能在下次垃圾收集时处理。
	    - CMS收集器不能像其他收集器那样等待到老年代几乎完全被填满了再进行收集，必须预留一部分空间供并发收集时的程序运作使用

    - **空间碎片**：基于标记-清除算法，*会产生大量空间碎片*，影响大对象的分配。

### 解决方案与参数

- **增量式并发收集器**(`i-CMS`): 尝试减少对用户程序影响，已在JDK 9中废弃。
- **空间整理策略**:
    - **`-XX:+UseCMSCompactAtFullCollection`**: Full GC时开启内存碎片整理，默认开启，JDK 9废弃。
    - **`-XX:CMSFullGCsBeforeCompaction`**: 设置进行多少次不整理空间的Full GC后进行一次碎片整理，默认每次Full GC都整理。

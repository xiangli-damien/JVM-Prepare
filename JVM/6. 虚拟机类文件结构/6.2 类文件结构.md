#### **概述**
##### 基本单位
- **二进制流**：Class文件是一组以*8字节为基础单位* 的二进制流，严格按照顺序排列，*不含任何分隔符* 。
- **数据项存储**：当数据项需要超过8字节时，将按*高位在前的方式* 分割为多个8字节存储。

##### 数据类型
-  Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，这种伪结构中只有两种数据类型: ==无符号数和 表==。

- **无符号数**：作为基本数据类型存在，分别用`u1`、`u2`、`u4`、`u8`表示1、2、4、8字节的无符号数，用于描述数值、索引引用、数量值或构成UTF-8编码的字符串值。
- **表**：复合数据类型，由无符号数或其他表构成，==所有表命名以`_info`结尾==，用于描述具有层次结构的复合数据。==Class文件本身也可以被视为一大表==。



```java
ClassFile {
    u4             magic; //Class 文件的标志
    u2             minor_version;//Class 的小版本号
    u2             major_version;//Class 的大版本号
    u2             constant_pool_count;//常量池的数量
    cp_info        constant_pool[constant_pool_count - 1];//常量池
    u2             access_flags;//Class 的访问标记
    u2             this_class;//当前类
    u2             super_class;//父类
    u2             interfaces_count;//接口数量
    u2             interfaces[interfaces_count];//一个类可以实现多个接口
    u2             fields_count;//字段数量
    field_info     fields[fields_count];//一个类可以有多个字段
    u2             methods_count;//方法数量
    method_info    methods[methods_count];//一个类可以有个多个方法
    u2             attributes_count;//此类的属性表中的属性数
    attribute_info attributes[attributes_count];//属性表集合
}
```

![[类文件结构.jpeg]]



####  **魔数与Class文件版本**

```java
u4             magic; //Class 文件的标志
```

- **魔数(Magic Number)**：每个Class文件的前4个字节被称为魔数，其唯一作用是*确定这个文件是否为一个能被虚拟机接受的Class文件* 。
	- Java 规范规定魔数为固定值：0xCAFEBABE

```java
    u2             minor_version;//Class 的小版本号
    u2             major_version;//Class 的大版本号
```
- **版本号**：紧接着魔数的是Class文件的版本号，包括两部分：==主版本号==和==次版本号==，用于标识Class文件的版本和格式，确保虚拟机能兼容不同版本的Class文件。
	- 使用 `javap -v` 命令来快速查看 Class 文件的版本号信息。
	- 高版本的 Java 虚拟机可以执行低版本编译器生成的 Class 文件，但是低版本的 Java 虚拟机不能执行高版本编译器生成的 Class 文件。



#### **常量池（Constant Pool）**

```java
    u2             constant_pool_count;//常量池的数量
    cp_info        constant_pool[constant_pool_count-1];//常量池
```


##### 常量池的作用与结构

- **常量池**：Class文件中的资源仓库，包含了*与类及接口定义相关的常量信息*，是Class文件中关联最多的部分，同时*占用较大空间* 。
- **计数值**：常量池的入口是一个u2类型的数据（`constant_pool_count`），表示*常量池容量* ，==计数从1开始==，第0项留空是为了特殊情况下表示“不引用任何一个常量池项目”。

##### 常量池的内容

- **动态语言支持**：除了基础类型，为了更好支持动态语言调用，Java虚拟机增加了与动态语言相关的常量类型。
- **模块化系统支持**：为支持Java模块化系统(Jigsaw)，引入`CONSTANT_Module_info`和`CONSTANT_Package_info`常量。
 - **常量类型**：包含**字面量(Literal)和符号引用(Symbolic References)** 两大类，
	 - ==字面量==如文本字符串，被声明为final的常量值等等。
	 - ==符号引用==：
		 - 被模块导出或者开放的包(Package)  
		 - *类和接口的全限定名(Fully Qualified Name)* 
		 - *字段的名称和描述符(Descriptor)*  
		 - *方法的名称和描述符*
		 - 方法句柄和方法类型(Method Handle、Method Type、Invoke Dynamic) 
		 - 动态调用点和动态常量(Dynamically-Computed Call Site、Dynamically-Computed Constant)

- **Java会在虚拟机加载的时候进行动态链接**，也就是说，在Class文件中不会保存各个方法、字段最终在内存中的布局信息，*这些字段、方法的符号引用不经过虚拟机在运行期转换的话是无法得到真正的内存入口地址，也就无法直接被虚拟机使用的* 。当虚拟机做类加载时，将会*从常量池获得对应的符号引用* ，再在类创建时或运行时解析、翻译到具体的内存地址之中。
##### 类型与标志

- **类型多样性**：至JDK 13为止，常量池中共有17种不同类型的常量，每种类型有独立的结构。
![[常量池类型.png]]
- **类型标志**：每种常量类型通过起始的u1类型的标志位(`tag`)区分，标志位决定常量的类型。


##### 符号引用与动态链接

- **符号引用**：包括类、接口、字段、方法的名称和描述符等，用于动态链接阶段解析为直接引用。
- **动态链接**：Java虚拟机在类加载时解析符号引用到具体的内存地址中，确保了类的动态加载和链接。

##### 为什么使用常量池

- **高效性**：常量池中存储的常量在Java虚拟机运行期间提供了快速的访问和检索方式。
- **灵活性**：支持多种类型的常量，为Java语言以外的其他语言提供了在JVM上运行的可能性。
- **独立性**：Java虚拟机通过与Class文件格式的紧密结合，不依赖于任何具体的编程语言，实现了程序的高度独立和移植性。


####  **访问标志**

```java
    u2             access_flags;//Class 的访问标记
```

- 指示类或接口及其字段、方法的访问权限（public、private等）和属性（如final、abstract等）。
- 访问标志可以标识某个类或接口属于哪个范围（如public表示可以被任意其他类访问）。
![[访问标志.png]]



####  **类索引、父类索引与接口索引集合**

- 类索引用于确定这个类的全限定名。
- 父类索引用于确定这个类的父类的全限定名，对于`java.lang.Object`类，没有父类，父类索引为0。
- 接口索引集合描述了类实现的接口，每个接口索引都是对常量池的引用，指向了一个接口的全限定名。

####  **字段表集合**

- 描述类或接口中声明的变量，包括类级变量（静态变量）和实例变量。
- 字段表包含了字段的名称、描述符、访问标志等信息。

#### **方法表集合**

- 描述类中的方法信息，包括方法的名称、返回类型、参数列表、访问标志等。
- 方法表中的每一项都是一个方法的完整描述，为虚拟机提供了足够的信息以执行方法。

#### **属性表集合**

- Class文件、字段表、方法表都可以携带自己的属性表。
- 属性表用于描述一些额外的信息，比如方法的代码、异常表、行号和局部变量表等。
- 属性表使得Class文件具有很好的扩展性，支持包含不同类型的属性。
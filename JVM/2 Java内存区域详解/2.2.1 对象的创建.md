以下是创建对象时Java虚拟机（JVM）的主要工作流程：

#### 1. 类加载检查

当JVM遇到`new`指令时，会执行以下步骤：
- 检查指令参数是否能在常量池找到==类的符号引用==。
- 确认符号引用表示的类是否已被加载、解析和初始化。
- 若未加载，则先进行类加载过程。

#### 2. 分配内存

类加载检查通过之后，为对象分配空间的任务等同于把一块确定大小的内存从 Java 堆中划分出来，分配方式有 **“指针碰撞”** 和 **“空闲列表”** 两种，选择哪种分配方式由 ==Java 堆是否规整==决定，而 Java 堆是否规整又由==所采用的垃圾收集器是否带有空间压缩整理功能（compact）==决定**。

- **指针碰撞**（假设堆是规整的）：
    - 即所有使用过的内存放在一边，空闲内存放在另一边，通过移动指针来分配内存。
    - 使用此法的GC策略：*Serial, ParNew*等压缩整理过程的收集器。

- **空闲列表**（假设堆不是规整的）：
    - 虚拟机需维护一个列表(Free List)来记录可用的内存块，在分配时从列表中找到足够的空间划分给对象实例。
    - 使用此法的GC策略：*CMS等基于清除算法的收集器*。


#### 3. 初始化零值

JVM需要保证所有对象实例字段在不赋初始值的情况下也能正常使用，因此内存分配完成后，虚拟机将分配到的内存空间（不包括对象头）==初始化为零值==。

#### 4. 设置对象头

虚拟机需要对对象进行必要的设置，例如这个对象是哪个类的实例，如何找到类的元数据信息，对象的哈希码、对象的GC分代年龄等。这些信息存放在对象的对象头中。

#### 5. 执行`<init>` 方法

最后，虚拟机执行对象的构造函数`<init>`方法，按程序员的意图进行初始化，这样一个可用的对象才算被完全构造出来。

#### 并发安全问题处理

- 在对象创建时，虚拟机如何保证操作的原子性和线程安全：
    - **CAS（Compare And Swap）**：CAS 是乐观锁的一种实现方式。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。*虚拟机采用 CAS 配上失败重试的方式保证更新操作的原子性。*
    - **TLAB（Thread Local Allocation Buffer）**：
	    - 为每一个线程预先在 Eden 区分配一块儿内存，JVM 在给线程中的对象分配内存时，首先在 TLAB 分配，
	    - 当对象大于 TLAB 中的剩余内存或 TLAB 的内存已用尽时，再采用上述的 CAS 进行内存分配

##### 参数配置

- `-XX:+/-UseTLAB`：设置是否开启TLAB。